include config.mk

alltarget = libnctplot.so
libraries = -lnctietue3 -lncurses -ldl -lnetcdf -lm
objects = nctplot.o
dependencies = nctplot.c functions.c function_wrappers.c nctplot.h shpname.h autogenerated/pager.h config.mk

ifdef have_shapelib
	CFLAGS += -DHAVE_SHPLIB
	libraries += -lshp -lm
	alltarget += ne_10m_coastline
	dependencies += coastlines.c coastlines_proj.c
endif
ifdef have_nctproj
	CFLAGS += -DHAVE_NCTPROJ
endif
ifdef have_proj
	CFLAGS += -DHAVE_PROJ
	libraries += -lproj
endif
ifdef have_png
	CFLAGS += -DHAVE_PNG
	libraries += -lpng
	dependencies += png.c
endif
ifdef have_wayland
	CFLAGS += -DHAVE_WAYLAND
	objects += wayland_helper/wayland_helper.o
	libraries += -lwayland-client -lxkbcommon
	dependencies += bindings_xkb.h wayland_spesific.c wayland_helper/wayland_helper.o
	objects_test = nctplot_debug.o test.o wayland_helper/wayland_helper.o
else
	libraries += -lSDL2
	dependencies += bindings.h sdl_spesific.c
	objects_test = nctplot_debug.o test.o
endif

all: $(alltarget)

autogenerated:
	mkdir -p autogenerated

autogenerated/pager.h: config.mk makepager.sh Makefile | autogenerated
	./makepager.sh $(shrdir)/nctplot/bindings.h $(pager)

functions.c: make_functions.pl functions.in.c | autogenerated
	./$< -q

function_wrappers.c: functions.c

libnctplot.so: $(objects)
	$(CC) -o $@ -shared $^ $(libraries)

nctplot.o: $(dependencies) config.mk
	$(CC) $(CFLAGS) -O0 -o $@ -c ${@:o=c}

nctplot_debug.o: $(dependencies) config.mk
	$(CC) $(CFLAGS) -g3 -gdwarf-2 -O0 -DDEBUG -o $@ -c nctplot.c

bindings_xkb.h: sdl2xkb.pl bindings.h
	./$<

wayland_helper/wayland_helper.o: wayland_helper/*
	cd wayland_helper && $(MAKE) wayland_helper.o --no-print-directory

shpname.h: Makefile config.mk
	printf "static const char* shpname = \"$(shrdir)/nctplot/ne_10m_coastline/ne_10m_coastline.shp\";\n" > $@

test.o: ../executable/*
	$(CC) -O0 -g -Wall -c ../executable/main.c -o $@

test.out: $(objects_test)
	$(CC) -o $@ $^ $(libraries)

ne_10m_coastline:
	curl https://www.naturalearthdata.com/http//www.naturalearthdata.com/download/10m/physical/ne_10m_coastline.zip -OL
	mkdir ne_10m_coastline
	unzip -d ne_10m_coastline ne_10m_coastline.zip
	rm ne_10m_coastline.zip

clean:
	rm -rf *.o *.out autogenerated functions.c function_wrappers.c libnctplot.so shpname.h
	cd wayland_helper && $(MAKE) $@

install: $(alltarget)
	cp libnctplot.so $(libdir)
	cp nctplot.h $(includedir)
	mkdir -p $(shrdir)/nctplot
	cp bindings.h $(shrdir)/nctplot
ifdef have_shapelib
	cp -r ne_10m_coastline $(shrdir)/nctplot
endif

uninstall:
	rm -rf $(libdir)/libnctplot.so $(includedir)/nctplot.h $(shrdir)/nctplot
