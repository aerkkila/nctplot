include config.mk

alltarget = libnctplot.so
libraries = -lnctietue3 -lncurses -ldl -lnetcdf -lm
objects =
dependencies = nctplot.c nctplot_graphics.c functions.c nctplot.h config.h config.mk

ifdef have_shapelib
	CFLAGS += -DHAVE_SHPLIB
	libraries += -lshp -lm
	alltarget += ne_10m_coastline ne_10m_lakes
	dependencies += coastlines.c proj.c
endif

ifdef have_nctproj
	CFLAGS += -DHAVE_NCTPROJ
endif

ifdef have_proj
	CFLAGS += -DHAVE_PROJ
	libraries += -lproj
endif

ifdef have_png
	CFLAGS += -DHAVE_PNG
	libraries += -lpng
	dependencies += png.c
endif

ifdef have_ttra
	CFLAGS += -DHAVE_TTRA
	objects += ttra/ttra.o
	libraries += `pkg-config --libs freetype2` -lutf8proc -lfontconfig
endif

ifdef have_wayland
	CFLAGS += -DHAVE_WAYLAND
	objects += waylandhelper/waylandhelper.o
	libraries += -lwayland-client -lxkbcommon
	dependencies += wayland_specific.c
	bindings_file = bindings_xkb.h
else
	libraries += -lSDL2
	dependencies += sdl_specific.c
	bindings_file = bindings_sdl.h
endif

dependencies += $(bindings_file)

all: $(alltarget)

config.h: config.mk makepager.sh Makefile
	printf "/* Automatically generated */\n" > $@
	printf "#ifndef __nctplot_config_h__\n#define __nctplot_config_h__\n" >> $@
	./makepager.sh $(shrdir)/nctplot/$(bindings_file) $(pager) >> $@
	printf "static const char *sharedir = \"$(shrdir)/nctplot\";\n" >> $@
	printf "#endif\n" >> $@

functions.c: make_functions.pl functions.in.c
	./$<

libnctplot.so: nctplot.o $(objects)
	$(CC) -o $@ -shared $^ $(libraries)

nctplot.o: $(dependencies) config.mk
	$(CC) $(CFLAGS) -o $@ -c ${@:o=c}

nctplot_debug.o: $(dependencies) config.mk
	$(CC) $(CFLAGS) -g3 -gdwarf-2 -O0 -DDEBUG -o $@ -c nctplot.c

waylandhelper/waylandhelper.o: waylandhelper/*
	cd waylandhelper && $(MAKE) waylandhelper.o --no-print-directory

ttra/ttra.o: ttra/*
	cd ttra && $(MAKE) ttra.o --no-print-directory

ne_10m_coastline:
	curl -OL https://naciscdn.org/naturalearth/10m/physical/ne_10m_coastline.zip
	mkdir $@
	unzip -d $@ ne_10m_coastline.zip
	rm ne_10m_coastline.zip

ne_10m_lakes:
	curl -OL https://naciscdn.org/naturalearth/10m/physical/ne_10m_lakes.zip
	mkdir $@
	unzip -d $@ ne_10m_lakes.zip
	rm ne_10m_lakes.zip

#pager.h:n ja shpname.h:n voi poistaa tästä myöhemmin
clean:
	rm -rf *.o *.out autogenerated functions.c function_wrappers.c libnctplot.so config.h pager.h shpname.h
	cd waylandhelper && $(MAKE) $@

install: $(alltarget)
	cp libnctplot.so $(libdir)
	cp nctplot.h $(includedir)
	mkdir -p $(shrdir)/nctplot
	cp $(bindings_file) $(shrdir)/nctplot
ifdef have_shapelib
	cp -r ne_10m_coastline ne_10m_lakes $(shrdir)/nctplot
endif

uninstall:
	rm -rf $(libdir)/libnctplot.so $(includedir)/nctplot.h $(shrdir)/nctplot
