include config.mk

alltarget = libnctplot.so

ifdef have_shapelib
	CFLAGS += -DHAVE_SHPLIB
	libraries += -lshp -lm
	alltarget += ne_10m_coastline
endif
ifdef have_nctproj
	CFLAGS += -DHAVE_NCTPROJ
endif

all: $(alltarget)

autogenerated:
	mkdir -p autogenerated

functions.c: make_functions.pl functions.in.c function_wrappers.c | autogenerated
	./$<

function_wrappers.c: make_functions1.pl
	./$<

autogenerated/functions_NC_INT.c: make_functions.pl functions.in.c | autogenerated
	./$<

libnctplot.so: nctplot.o
	$(CC) -o $@ -shared $^ $(libraries)

colormaps.h: make_colormaps.sh colormaps
	./$<

nctplot.o: nctplot.c nctplot.h functions.c colormaps.h config.mk coastlines.c shpname.h
	$(CC) $(CFLAGS) -o $@ -c $<

shpname.h: Makefile config.mk
	printf "static const char* shpname = \"$(shrdir)/nctplot/ne_10m_coastline/ne_10m_coastline.shp\";\n" > $@

ne_10m_coastline:
	curl https://www.naturalearthdata.com/http//www.naturalearthdata.com/download/10m/physical/ne_10m_coastline.zip -OL
	mkdir ne_10m_coastline
	unzip -d ne_10m_coastline ne_10m_coastline.zip
	rm ne_10m_coastline.zip

clean:
	rm -rf *.o autogenerated colormaps.h functions.c function_wrappers.c libnctplot.so shpname.h

install: libnctplot.so
	cp libnctplot.so $(libdir)
	cp nctplot.h $(includedir)
ifdef have_shapelib
	mkdir -p $(shrdir)/nctplot
	cp -r ne_10m_coastline $(shrdir)/nctplot
endif

uninstall:
	rm -rf $(libdir)/libnctplot.so $(includedir)/nctplot.h $(shrdir)/nctplot
